---
title: EventLoop 并发模型与事件循环
date: 2020-06-12 15:06:51
tags:
---
##### JS 有一个基于***事件循环***的并发模型，事件循环负责执行代码、搜集和处理事件以及执行队列中的子任务
*** JS 是单线程语言 ***
![](/images/事件循环可视化描述.jpeg)

***可能的缺陷*** : 每一个消息完整地执行后，其它消息才会被执行; 所以当一个消息需要太长时间才能处理完毕时，Web应用程序就无法处理与用户的交互，例如点击或滚动

***事件和回调函数*** :
  事件: 用户点击、页面滚动、ajax onload、IO 事件等等
  回调函数: 被挂起等待对应事件触发然后进栈执行的代码

***setTimeout*** : 第二个参数为 ***最小等待时间***

##### 多个运行时互相通信
一个 web worker 或者一个跨域的 iframe 都有自己的栈、堆和消息队列。两个不同的运行时只能通过 postMessage 方法进行通信。如果另一个运行时侦听 message 事件，则此方法会向该运行时添加消息
<!--more-->

##### 永不阻塞
JavaScript的事件循环模型与许多其他语言不同的一个非常有趣的特性是，它永不阻塞。 处理 I/O 通常通过事件和回调来执行，所以当一个应用正等待一个 IndexedDB 查询返回或者一个 XHR 请求返回时，它仍然可以处理其它事情，比如用户输入

##### 同步任务与异步任务、宏任务与微任务
![](/images/同步任务与异步任务.jpeg)
步骤:
1. 同步和异步任务分别进入不同的执行"场所"，同步的进入主线程，异步的进入 ***Event Table*** 并注册函数
2. 当指定的事情触发时，Event Table会将这个函数移入 ***Event Queue***
  ***注意细节*** : Event Queue 中是已经被触发的回调函数，一旦主线程空闲，队列中的第一个就会进栈执行；而 Event Table 是一个用于存储暂未触发的异步事件列表，比如还没有到达最小等待时间的 setTimeout 和 还没有成功的 ajax onload，一旦 超过最小等待时间，setTimeout 的第一个参数会被推进 Event Queue 中排队等待执行，一旦 ajax 成功，则 Onload 回调会被推进 Event Queue 中排队等待执行
3. 主线程内的任务执行完毕为空，会去Event Queue读取对应的函数，进入主线程执行
4. 上述过程会不断重复
***

![](/images/宏任务.jpeg)
![](/images/微任务.jpeg)
![](/images/宏任务与微任务的执行顺序.jpeg)

