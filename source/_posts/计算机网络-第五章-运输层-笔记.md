---
title: 计算机网络 第五章 运输层 笔记
date: 2020-06-22 17:04:36
tags:
---
***关键词*** : 

##### 重要概念
1. 运输层为相互通信的应用进程提供逻辑通信
2. 端口和套接字的意义
3. ***无连接的 UDP*** 的特点
4. ***面向连接的 TCP*** 的特点
5. 在不可靠的网络上实现可靠传输的工作原理，停止等待协议和 ARQ 协议
6. TCP 的滑动窗口、流量控制、拥塞控制和连接管理

#### 运输层协议概述
***复用(multiplexing)*** : 不同应用进程可以使用同一个运输层协议传送数据
***分用(demultiplexing)*** : 运输层可以把数据正确交付不同应用进程
***逻辑通信*** : 运输层到运输层的逻辑平行传送数据
***屏蔽*** : 屏蔽了下面网络的核心细节
***差错检查*** : 运输层对收到的整个报文进行差错检测
***运输协议数据单元(TPDU)*** : Transport Protocol Data Unit 两个对等运输实体在通信时传送的数据单位，在 TCP/IP 体系中，分别称为 ***TCP 报文段(segment)*** 和 ***UDP 用户数据报***

##### 运输层端口
***协议端口号(protocol port number)*** : 在协议栈层间的抽象的协议端口，是应用层的各种协议进程与运输实体进程间交互的一种地址
1. TCP/IP 的运输层用一个 ***16位*** 端口号来标志一个端口
2. 端口号只具有本地意义
***熟知端口号*** : 也称 ***系统端口号***，数值 0~1023
![](/images/常用的熟知端口号.jpeg)
***登记端口号*** : 数值 1024~49151
***短暂端口号*** : 数值 49152~65535

#### UDP 用户数据报协议
UDP : User Datagram Protocol
***特点*** :
1. 无连接，传送数据之前不需要建立连接，收到数据不需要给出确认
2. 不提供可靠交付(只尽最大努力交付)，某些情况下是一种有效的工作方式
3. UDP 是面向报文的。UDP 对应用层交下来的报文即不合并也不拆分，使用 UDP 协议时，应用程序必须选择合适大小的报文，以免影响 IP 层的效率
4. UDP 没有拥塞控制: 源主机以恒定的速率发送数据，允许丢失数据，但不允许有太大的时延，如 IP 电话、实时视频会议
5. UDP 支持一对一、一对多、多对一、多对多的交互通信
6. UDP 的首部只有 8 个字节
- UDP 首部
![](/images/UDP首部和伪首部.jpeg)
**UDP 伪首部** 是临时添加用于计算校验和的，即不向下传送也不向上提交
![](/images/计算UDP校验和栗子.jpeg)

#### TCP 传输控制协议
- - -
TCP : Transmission Control Protocol
***特点*** :
1. TCP 提供面向连接的服务，传送数据之前先建立连接，传送结束后释放连接
  连接是 **虚连接** **逻辑连接**
2. TCP 不提供广播或多播服务
3. TCP 提供可靠的、面向连接的服务，因此会增加开销
  TCP 数据 无差错、不丢失、不重复、并且按序到达
4. 每一条 TCP 连接只能有两个 **端点(endpoint)**，即 TCP 连接 是 **点对点** 的
5. TCP 提供 **全双工通信**。即两端都有相同的收发数据的功能
  ***单工通信*** 就是只能从A到B,如[广播]
  ***半双工通信*** 是A到B,B到A都行,但不能同时进行.如[对讲机]
  ***全双工通信*** 是A到B,B到A都行,且可以同时进行.如[电话]
6. TCP 面向字节流。TCP 把应用程序交下来的数据看成是一连串的 **无结构的字节序列**
![](/images/TCP面向字节流.jpeg)
7. TCP 不关心应用进程的报文长度，而是根据对方给出的窗口值和当前网络拥塞的程度来决定一个 segment 应包含多少字节。根据情况进行分块或者等待积累
***TCP 的连接*** : 抽象的连接
TCP 连接的端点称为 **套接字(socket)** 或插口
套接字定义 : 端口号拼接到 IP 地址 -- socket = (IP 地址：端口号)
每一条 TCP 连接唯一地被通信两端的两个端点(即两个套接字)所确定 :
**TCP 连接 ::= {socket1, socket2} = {(IP1：port1), (IP2：port2)}**

#### 可靠传输的工作原理
IP 层只提供尽最大努力服务；传输信道不可靠
使用可靠传输协议 :
***自动重传请求 ARQ (Automatic Repeat reQuest)*** : 可靠传输协议常称为 ARQ，意思是重传的请求是自动进行的，接受方不需要请求发送方重传某个出错的分组
1. 停止等待协议
信道利用率低
发送、确认、出现差错、超时重传、确认丢失、确认迟到、丢弃差错分组、丢弃重复分组
2. 连续 ARQ 协议 和 滑动窗口协议
滑动窗口协议是 TCP 协议的精髓、**发送窗口**连续发送分组、
累计确认: 对按序到达的最后一个分组发送确认（如果5个分组的第3个丢失了，则后面三个全部要重传）

#### TCP 的流量控制
- 利用滑动窗口实现流量控制
流量控制: 让发送方的发送速率不要太快，让接收方来得及接受；
互相等待的死锁局面: 接收方B发送的接受窗口值报文丢失了，导致发送方A一直等待这个报文，接收方B一直等待数据; 解决办法是 **持续计时器**
- TCP 的传输效率
发送方让数据到达发送窗口的一半或者已达到报文段的最大长度时，就发送一个报文段
接受方等待接收缓存足够容纳一个最长的报文段，或者等到接收缓存已有一半的空闲空间，就发出确认报文

#### TCP 的拥塞控制
***拥塞*** : 在计算机中的链路容量（即带宽）、交换节点中的缓存和处理机等，都是网络的资源。在某段时间，对网络中某一资源的需求超过了该资源所能提供的可用部分，网络的性能就要变坏。这种情况就叫做拥塞。

#### TCP 的运输连接管理
***握手** : TCP 连接建立的过程
***三报文握手*** : 在一次握手过程中交换了三个报文
![](/images/三报文握手.jpeg)
- 连接过程
TCP 规定，SYN 报文段（SYN = 1 的报文段）不能携带数据，但要消耗一个序号
四报文握手 : 上图中 B 发送给 A 的报文段，也可拆成两个报文段。可以先发送一个确认报文段(ACK = 1, ack = x + 1)，然后再发送一个同步报文段(SYN = 1, seq = y)。这样的过程就变成了 **四报文握手**。
***为什么A最后还要发送一次确认？*** :
主要是为了防止 **已失效的连接请求报文段** 突然又传送到了 B (A 发送的第一个连接请求报文段在某个结点长时间滞留了(然后 A 重发了一次建立了连接)，延误到连接释放之后才到达 B，B 误以为 A 又发出一次连接请求，返回一个确认报文段，这时需要 A 给与一个确认，才可以建立连接，不然 B 就一直等待A发送数据)
- TCP 的连接释放 :
![](/images/TCP连接释放.jpeg)
半关闭状态 : 客户端已经没有数据发送了，但如果服务器端发送数据，客户端仍然要接受
时间等待计时器 : TIME-WAIT timer, 2MSL
时间 MSL : 最长报文段寿命，一般小于 2 分钟
客户端发送最后一个确认报文段时，会重启 时间等待计时器
***保活计时器*** : keepalive timer, TCP 连接建立后，服务器每收到一次客户端的数据，就重置保活计时器，时间通常是 2 小时。超过两小时没有收到客户端的数据，服务器就发送一个探测报文段，每隔 75秒 发送一次，若连续 10个 探测报文段都得不到客户端的响应，服务器就会关闭连接
- TCP 的有限状态机
粗实线箭头表示对客户进程的正常变迁
粗虚线箭头表示对服务器进程的正常变迁
细线箭头表示异常变迁
![](/images/TCP有限状态机.jpeg)

![](/images/应用层协议使用的运输层协议对照.jpeg)


运输层协议特点
进程间的通信
端口
TCP UDP
可靠传输的工作原理
TCP 的三个重要问题: 滑动窗口、流量控制、拥塞控制机制